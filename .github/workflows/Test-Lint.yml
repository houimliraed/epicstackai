name: test and lint

on:
  workflow_call:

jobs:
  react:
    name: React test-lint
    runs-on: ubuntu-latest
    steps:
      - name: Code checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Test
        working-directory: frontend
        run: npm run test

      - name: Lint
        working-directory: frontend
        run: npm run lint


  backend:
    name: FastAPI lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.13

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8

    - name: Lint code
      working-directory: backend
      run: |
        source venv/bin/activate
        flake8 .
  terraform:
    name: Terraform lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Terraform lint & format
        run: |
          cd infra/
          docker compose run --rm terraform -chdir=deploy init -backend=false
          docker compose run --rm terraform -chdir=setup init -backend=false
          docker compose run --rm terraform -chdir=deploy validate
          docker compose run --rm terraform -chdir=setup validate
          docker compose run --rm terraform -chdir=deploy fmt -check
          docker compose run --rm terraform -chdir=setup fmt -check
